# Investigator — Pipeline Reference

Technical guide for engineers running investigations, extending the pipeline, or understanding how the system works internally.

For a non-technical overview see [README.md](./README.md). For the build history and design rationale see [BUILD-STORY.md](./BUILD-STORY.md).

---

## Prerequisites

- Python 3.10+ (no third-party packages — stdlib only)
- Claude Code (for spawning agents)
- No build step, no package manager, no compiled assets

---

## Repository Layout

```
scripts/
  json_to_md.py          # Generates all markdown from investigation.json
  check_sync.py          # Verifies JSON and markdown are in sync

templates/
  agent_persona.md       # System prompt for the investigation agent
  validator_persona.md   # System prompt for the validation agent
  investigation.md       # Human-readable template reference (not used by agents)
  investigation.schema.json  # Field definitions and examples
  validation_report.md   # Validation report template reference

CLAUDE.md                # Orchestration rules for this Claude Code session
PIPELINE.md              # This document
README.md                # General audience overview
BUILD-STORY.md           # Design rationale and iteration history
.gitignore               # Investigations never go to git — whitelist approach
.no-tdd                  # Suppresses the global TDD enforcer hook for this repo

<InvestigationName>/     # PascalCase — one folder per investigation
  investigation.json     # Authoritative source — agents write this, never the markdown
  investigation.md       # Generated by json_to_md.py
  glossary.md            # Generated by json_to_md.py (when concepts list is populated)
  brief_leadership.md    # Generated by json_to_md.py (technical investigations only)
  brief_po.md            # Generated by json_to_md.py (technical investigations only)
  validation_report.md   # Written by the validation agent
```

**Rule:** `investigation.json` is the only file agents write. All markdown is derived by script and must never be hand-edited.

---

## Running an Investigation — Step by Step

### 1. Scope gate

Before spawning any agent, answer these four questions:

1. **What is the single core question?** — One sentence. If it can't be stated in one sentence, split it.
2. **What is out of scope?** — Name at least one related area that will not be covered.
3. **Who is the intended consumer?** — Engineer, Leadership, PO/EM, or all three?
4. **Are there sub-topics that warrant separate investigations?** — If yes, plan separate folders.

A broad question like "tell me about cloud security" must be narrowed before proceeding.

### 2. Create the investigation folder

```
mkdir <PascalCase name>
```

Use PascalCase — no hyphens, underscores, or spaces. Examples: `MsDefenderAwsExclusions`, `AwsIamPrivilegeEscalation`.

### 3. Spawn the investigation agent

Use the persona in `templates/agent_persona.md` as the system prompt. Pass the scoped question and the folder path. The agent:

- Researches the question from live sources
- Writes `investigation.json` to the folder
- Runs `python3 scripts/json_to_md.py <folder>` to generate markdown
- Runs `python3 scripts/check_sync.py <folder>` — must exit 0 before returning

Do not accept a result until `check_sync.py` exits 0.

### 4. Spawn the validation agent

Use the persona in `templates/validator_persona.md` as the system prompt. Pass `investigation.json` as structured input (not the markdown). The agent:

- Runs `check_sync.py` first and pastes the output into the report
- Verifies every source URL
- Spot-checks high-stakes factual claims against live documentation
- Writes `validation_report.md` to the folder

### 5. Remediation (if required)

| Verdict | Action |
|---------|--------|
| `CONTRADICTED` | Re-spawn investigation agent with the specific claim and contradicting evidence. Agent corrects `investigation.json` and re-runs both scripts. |
| `UNVERIFIED` (material) | Correct or downgrade to `open_questions` |
| `UNVERIFIED` (minor) | Leave with a note in `open_questions` |
| `PARTIALLY CONFIRMED` | Narrow the claim to only what was confirmed |
| `DEAD` source | Replace with accessible equivalent or remove |
| `REDIRECT` source | Update URL in `investigation.json`, re-run `json_to_md.py` |
| `OUT_OF_SYNC` | Re-run `json_to_md.py` |

After any correction: re-run `json_to_md.py` → re-run `check_sync.py` → must exit 0.

---

## Scripts

### `json_to_md.py`

Generates all markdown from `investigation.json`. This is the only way markdown should be produced.

```bash
python3 scripts/json_to_md.py <investigation_dir>
python3 scripts/json_to_md.py <investigation_dir> --dry-run   # print to stdout, no write
```

**Files produced:**

| File | Condition |
|------|-----------|
| `investigation.md` | Always |
| `glossary.md` | When `concepts` list is non-empty |
| `brief_leadership.md` | When `audience_briefs.engineering_leadership` is present |
| `brief_po.md` | When `audience_briefs.product_owner` is present |

**Exit codes:** `0` = success, `2` = error (invalid JSON, missing required field, I/O failure)

**Required fields:** `topic`, `date`, `status`, `question`, `context` — missing any of these exits 2.

**URL validation:** source `url` values are validated for scheme. Only `https://` and `http://` pass through. Any other scheme (`javascript:`, `data:`, etc.) is silently dropped.

**Atomic writes:** each file is written via temp file + `os.replace()` — a crash mid-write cannot corrupt an existing file.

---

### `check_sync.py`

Verifies that `investigation.md` content matches `investigation.json` across five fields. Also checks that brief files exist when `audience_briefs` is present in JSON.

```bash
python3 scripts/check_sync.py <investigation_dir>
```

**Exit codes:** `0` = IN_SYNC, `1` = OUT_OF_SYNC, `2` = error

When OUT_OF_SYNC, the script prints exactly which items are in JSON but missing from markdown and vice versa, with a recovery hint.

**Fields checked:** `key_findings`, `tensions`, `open_questions`, `sources`, `concepts`

**Not checked:** `topic`, `date`, `status`, `question`, `context`, `quick_reference`, and `audience_briefs` content — these are either rendered verbatim or only checked for file existence. Drift in these fields would only occur from hand-editing the markdown (which is prohibited).

---

## JSON Schema

Full field reference. The script enforces five required fields (`topic`, `date`, `status`, `question`, `context`) — missing any of these exits with code 2. All other fields (`key_findings`, `concepts`, `tensions`, `open_questions`, `sources`) are not script-enforced but are required for a complete investigation. `quick_reference` and `audience_briefs` are conditional.

```jsonc
{
  "topic":    "string — investigation title, used as markdown H1",
  "date":     "string — YYYY-MM-DD",
  "status":   "string — 'complete', 'in_progress', etc. Rendered Title Case.",
  "question": "string — the exact question being investigated",
  "context":  "string — why this topic matters; 1–3 paragraphs",

  // Optional — rendered at the top of investigation.md before findings
  "quick_reference": {
    "title":   "string — table heading, defaults to 'Quick Reference'",
    "columns": ["string"],
    "rows":    [["string"]],
    "notes":   "string — rendered as a blockquote below the table"
  },

  "key_findings":  ["string — standalone, atomic insight; one per item"],
  "concepts": [
    { "name": "string", "description": "string" }
  ],
  "tensions":       ["string — competing force or unresolved tradeoff"],
  "open_questions": ["string — what the investigation couldn't answer"],
  "sources": [
    { "title": "string", "url": "string — must be https:// or http://" }
  ],

  // Required for technical investigations; omit entirely for non-technical topics
  "audience_briefs": {
    "engineering_leadership": {
      "headline":        "string — one punchy sentence",
      "so_what":         "string — risk/impact in 1–2 sentences",
      "bullets":         ["string — 3–5 items, impact/risk/decision focused"],
      "action_required": "string or null"
    },
    "product_owner": {
      "headline":    "string — plain English, zero jargon",
      "so_what":     "string — business impact in 1–2 sentences",
      "bullets":     ["string — 3–5 items a non-engineer can act on"],
      "risk_level":  "Low | Medium | High | Critical",
      "next_steps": {
        "po_action":        "string — what PO/EM needs to decide or kick off",
        "work_to_assign":   ["string — discrete items to hand to engineers"],
        "leadership_input": "string or null"
      },
      "questions_to_ask_engineering": ["string — 1–3 questions"]
    }
  }
}
```

### Field constraints (trust boundary)

The renderer outputs field values verbatim. Agents must observe:

- No embedded `\n` in single-value fields (`headline`, bullets, list items, concept names, source titles) — newlines break blockquote and table rendering
- Concept `name` must not start with `#` — it renders as a heading in the glossary
- Source `url` must use `https://` or `http://` — other schemes are dropped silently

---

## Audience Brief Decision Tree

```
Is this a technical investigation?
(infra, security, config, operational risk)
  │
  ├── YES → include audience_briefs
  │           both engineering_leadership and product_owner
  │
  └── NO  → omit audience_briefs entirely
            (market events, financial analysis, historical research,
             organisational topics, anything with no engineering implication)
             No brief files will be generated. This is intentional.
```

If unsure: *would a PO or VP of Engineering need to act on or be briefed on these findings?* If no, omit.

---

## Naming Convention

Investigation subfolders use **PascalCase** — no hyphens, underscores, or spaces.

```
MsDefenderAwsExclusions/
AwsIamPrivilegeEscalation/
LlmContextWindows/
RxtShortSqueeze/
```

The legacy folder `ms-defender-aws-exclusions/` predates this convention. All new investigations use PascalCase.

---

## Adding a New Investigation

```bash
# 1. Create folder
mkdir NewInvestigationName

# 2. Run the investigation agent (see templates/agent_persona.md)
#    Agent writes investigation.json and runs both scripts

# 3. Confirm sync
python3 scripts/check_sync.py NewInvestigationName
# Must exit 0

# 4. Run the validation agent (see templates/validator_persona.md)
#    Validator writes validation_report.md

# 5. Apply any remediation, re-run scripts, re-confirm exit 0

# 6. Add to the investigations table in README.md
```

Investigations never go to git — `.gitignore` excludes all investigation folders via a whitelist approach.

---

## Common Errors

| Error | Cause | Fix |
|-------|-------|-----|
| `ERROR: investigation.json contains invalid JSON` | Syntax error in JSON | Fix the JSON, re-run `json_to_md.py` |
| `ERROR: investigation.json is missing required fields: topic, date` | Agent omitted required fields | Fix `investigation.json`, re-run |
| `Result: OUT_OF_SYNC — key_findings` | Markdown was hand-edited or not regenerated | Re-run `json_to_md.py` |
| `brief_leadership.md  OUT_OF_SYNC (missing file)` | `audience_briefs` present in JSON but markdown not generated | Re-run `json_to_md.py` |
| Source URL dropped from rendered markdown | URL scheme was not `https://` or `http://` | Fix the URL in `investigation.json` |

---

## Template Files

| File | What it is |
|------|-----------|
| `templates/agent_persona.md` | System prompt for the investigation agent — defines research constraints, output format, and JSON field requirements |
| `templates/validator_persona.md` | System prompt for the validation agent — defines verification scope, verdict taxonomy, and report format |
| `templates/investigation.schema.json` | JSON field definitions and annotated examples |
| `templates/investigation.md` | Human-readable template showing the expected structure of a completed investigation |
| `templates/validation_report.md` | Template showing the expected structure of a validation report |
